var http=require('http'); 
var request=require('request'); // https://github.com/request/request
var should = require('should');
var xpath=require('xpath'); // https://www.npmjs.com/package/xpath
var dom = require('xmldom').DOMParser;
var querystring=require('querystring');

getStateVars=function(body) {

body=body
    .replace(/[\n\t\r]/g,"")
    .replace(/.*(<form[^>]*>).*(<input.*__VIEWSTATE[^>]*>).*(<input.*__EVENTVALIDATION[^>]*>).*(<\/form>).*/,"$1$2$3$4")
; // correcting html

var doc = new dom().parseFromString(body)
var vs = xpath.select("//input[@id='__VIEWSTATE']/@value", doc)[0].nodeValue;
var ev = xpath.select("//input[@id='__EVENTVALIDATION']/@value", doc)[0].nodeValue;
return {vs:vs,ev:ev};
};

/*cleanHtml=function(body) {
return body
    .replace(/&nbsp;/g,"")
    .replace(/(<td.*LeftBack.png.*>)/,"<tr>$1")
    .replace(/(<td.*RightBack.png.*>[^<]*<\/td>)/,"$1</tr>")
; // correcting html
};*/

exports.handler = function(data,callbackFn) {
var j = request.jar();

    var options = {
        url:"http://www.parkmeterlebanon.com/statment_of_account.aspx",
        timeout:5000,
        headers: {
          'Cache-Control': 'no-cache'
         },
         jar:j
    };

    request.get(options, function(err,res,body) {

if(err!=null || res.statusCode!=200) { callbackFn("Not available"); return; }

vsev=getStateVars(body);

        options.form={
		'__EVENTTARGET':'',
		'__EVENTARGUMENT':'',
		'__VIEWSTATE':vsev.vs,
		'__EVENTVALIDATION':vsev.ev,
		'ctl00$btnEnglish.x':15,
		'ctl00$btnEnglish.y':13
        };
        request.post(
            options,
            function (error, response, body) {
                if (error || response.statusCode != 200) {
                  callbackFn("Not available");
                  return;
                }

vsev=getStateVars(body);

        options.form={
		'__EVENTTARGET':'',
		'__EVENTARGUMENT':'',
		'__VIEWSTATE':vsev.vs,
		'__EVENTVALIDATION':vsev.ev,
		'ctl00$ContentPlaceHolder1$txtCarNumber':data.n,
		'ctl00$ContentPlaceHolder1$cmbCarType':data.a,
		'ctl00$ContentPlaceHolder1$btnSearch':'SUBMIT'
        };
fBkp=options.form;
options.form = querystring.stringify(options.form);
options.form=options.form.replace(/B%2F%EF%BA%8F/,"B%2F%D8%A8");
//options.headers = {'content-type': 'application/x-www-form-urlencoded; charset=UTF-8',
//          'Cache-Control': 'no-cache',
//'content-length': options.body.length
//};
//delete options.form;

rereq=        request.post(
            options,
            function (error, response, body) {
  var cookie_string = j.getCookieString(options.url); // "key1=value1; key2=value2; ..."
  var cookies = j.getCookies(options.url);

                if (error || response.statusCode != 200) {
                  callbackFn("Not available: "+error+","+response.statusCode);
                  return;
                }

//                                         <span id="ctl00_ContentPlaceHolder1_lblResult" style="display:inline-block;"><b><font color="Red" size="6">TOTAL AMOUNT: 0  LBP</font></b></span><br />
body=body.replace(/[\n\t\r]/g,"").replace(/.*(<span id="ctl00_ContentPlaceHolder1_lblResult" style="display:inline-block;"><b><font color="Red" size="6">[^<>]*<\/font><\/b><\/span>).*/,"$1"); // correcting html

// http://stackoverflow.com/questions/16010551/getting-element-using-xpath-and-cheerio
var doc = new dom().parseFromString(body)
var m2 = xpath.select("//span[@id='ctl00_ContentPlaceHolder1_lblResult']/b/font/text()", doc).toString();
//console.log("M1",m2,data);

	m2 = m2.replace(/[\n\t\r]/g,"");
//console.log("M2",m2,data);

	// some string manipulation
	if(m2=="TOTAL AMOUNT: 0  LBP"||m2=="THERE IS NO OUTSTANDING SURCHARGES") {
           m2="None";
        } else {
           m2=m2.replace(/TOTAL AMOUNT: /,"");
        }

                    callbackFn(m2);
            }
        ); // end request.post

}); // end request.post

    }); // end request.get

}; // end function  
