var DdbUser = require("app/DdbUser");
var MailManager = require('app/MailManager');

module.exports.login = function (event,context) {
  du = new DdbUser(event,context,false);
  du.loginCore();
};

module.exports.forgotPassword = function (event,context) {
  du = new DdbUser(event,context,false);
  du.connect(function() {
    if(!du.checkEmailRegistered()) {
      du.context.fail("Email address not registered.");
      return;
    }
    if(!du.checkPassFail()) {
      this.context.fail("Account locked.");
      return;
    }
    du.incrementPassFail(function() {
      // send email
      MailManager.mailSend(
        du.event.email,
        "Zboota forgotten password",
        "Welcome to Zboota. Your password is "+du.entry.pass,
        { fail: function(err) { du.context.fail(angular.toJson({error: "Failed to send email to "+du.event.email})); },
          succeed: function() { du.context.succeed("{}"); }
        }
      );
    });
  });

};

