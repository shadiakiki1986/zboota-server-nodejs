var http=require('http'); 
var request=require('request'); // https://github.com/request/request
var should = require('should');
var xpath=require('xpath'); // https://www.npmjs.com/package/xpath
var dom = require('xmldom').DOMParser;
var Validator = require('app/Validator');

var trim = function(x) { return x.replace(/[\n\t\r]/g,"").replace(/^\s*/g,""); };

var number_format=function(nStr) {
    nStr += '';
    var x = nStr.split('.');
    var x1 = x[0];
    var x2 = x.length > 1 ? '.' + x[1] : '';
    var rgx = /(\d+)(\d{3})/;
    while (rgx.test(x1)) {
        x1 = x1.replace(rgx, '$1' + ',' + '$2');
    }
    return x1 + x2;
};

exports.handler = function(data,callbackFn) {
  
  var anyMissing = !data.hasOwnProperty("y")||!data.hasOwnProperty("hp")||!data.hasOwnProperty("t")||!data.hasOwnProperty("n")||!data.hasOwnProperty("a");
  if(anyMissing) {
    callbackFn("Data missing fields");
    return;
  }
  
  if(!Validator.validArea(data.a)) {
    callbackFn("Invalid area code");
    return;
  }
  
  if(!Validator.validNumber(data.n)) {
    callbackFn("Invalid plate number");
    return;
  }
  
  var j = request.jar();
  
  var options = {
    url:'http://www.dawlati.gov.lb/en/mecanique',
    timeout:5000,
    headers: {
      'Cache-Control': 'no-cache',
      'Referer': 'http://www.dawlati.gov.lb/en/mecanique'
    },
    jar:j
  };
  
  request.get(options, function(err,res,body) {
  
    if(err!=null) { callbackFn("Not available"); return; }
    if(res.statusCode!=200) { callbackFn("Not available"); return; }
  
    body=trim(body).replace(/.*(<form[^>]*_dawlatimecanique_WAR_dawlatimecaniqueportlet_fm[^>]*>.*<\/form>).*/,"$1")
      .replace(/ <\/div> <!-- results --> <\/div> <\/div> <\/div> <\/div> <\/div> <\/div> <\/div> <\/div> <\/div> <\/div> <form action="#" id="hrefFm" method="post" name="hrefFm"> <span><\/span> <\/form>/,"")
      .replace(/<input[^>]*__ncforminfo[^>]*>/,"")
      .replace(/checked/g,"checked='checked'")
      .replace(/style="width:50%;"id/,"style='width:50%;' id")
    ; // simplifying html
  
    var doc = new dom().parseFromString(body)
    options.url = xpath.select("//form[@id='_dawlatimecanique_WAR_dawlatimecaniqueportlet_fm']/@action", doc)[0].nodeValue;
  
    // check valid inputs
    //$fat32=array("Private cars","Motorcycles","Mass public transport trucks","Taxis","Public buses & minibuses","Private transport vehicles","Other private vehicles: Ambulances, etc...");
    if(!Validator.validDawlatiMechanique(xpath.select('//td[@id="zVehiculeType"]//input[@name="_dawlatimecanique_WAR_dawlatimecaniqueportlet_vehicleType"]/@value',doc),data.t,"car type")) {
      callbackFn("Invalid vehicle type");
      return;
    }
  
    if(!Validator.validDawlatiMechanique(xpath.select('//select[@id="_dawlatimecanique_WAR_dawlatimecaniqueportlet_modelYear"]//option/@value',doc),data.y,"model year")) {
      callbackFn("Invalid model year");
      return;
    }
  
    if(!Validator.validDawlatiMechanique(xpath.select('//td[@id="zHorsePower"]//input[@name="_dawlatimecanique_WAR_dawlatimecaniqueportlet_horsePower"]/@value',doc),data.hp,"horse power")) {
      callbackFn("Invalid horse power");
      return;
    }
  
    options.form={
      '_dawlatimecanique_WAR_dawlatimecaniqueportlet_modelYear': data.y,
      '_dawlatimecanique_WAR_dawlatimecaniqueportlet_horsePower': data.hp,
      '_dawlatimecanique_WAR_dawlatimecaniqueportlet_vehicleType': data.t,
      '_dawlatimecanique_WAR_dawlatimecaniqueportlet_plateNumber' : data.n,
      '_dawlatimecanique_WAR_dawlatimecaniqueportlet_areaCode': data.a
    };
    request.post(
       options,
       function (error, response, body) {
         if(error!=null) { callbackFn("Not available"); return; }
         if(response.statusCode != 200) { callbackFn("Not available"); return; }
 
        body=body.replace(/.*(<table[^>]*zResult[^>]*>.*<\/table>).*/,"$1")
          .replace(/color = red/g,"color='red'")
          .replace(/color=red/g,"color='red'")
          .replace(/&nbsp;/g,"")
          .replace(/<\/font><\/b>/,"</b></font>")
        ; // simplifying html
        //console.log("body",body)
        // http://stackoverflow.com/questions/16010551/getting-element-using-xpath-and-cheerio
        var doc = new dom().parseFromString(body)
        var m0 = xpath.select("string(//table[@id='zResult']/tr[1]/td[1])", doc);
    
        if(m0) {
    
          m0 = trim(m0.toString());
      //console.log("m0:",m0);
    
          if(m0=="There are no results matching the specifications you've entered...") {
            //throw new Exception($m0);
            callbackFn(m0);
            return;
          } else {
            m2 = trim(xpath.select('//table[@id="zResult"]/tr[2]/td[1]/font/b/text()',doc)[0].nodeValue);
            m2=number_format(m2);
            m1 = trim(xpath.select('//table[@id="zResult"]/tr[3]/td[1]/font/b/text()',doc)[0].nodeValue);
            m3 = xpath.select('//table[@id="zResult"]/tr[4]/td[1]/font/b/text()',doc);
            if(m3.length==0) {
              m3=true;
            } else {
              m3 = trim(xpath.select('//table[@id="zResult"]/tr[4]/td[1]/font/b/text()',doc)[0].nodeValue);
              m3 = (m3!="Your vehicle is not subject to the Mandatory Vehicle Inspection");
            }
            // return
            dm={"amount":m2,"month":m1,"inspection":m3};
            callbackFn(dm.amount+" LL, due in "+dm.month+", mandatory inspection: "+(dm['inspection']?"required":"not required"));
            return;
          }
        } else {
          // check if got server error on forbidden access
          m02 = xpath.select('//h3[@class="portlet-msg-error"]',doc);
          if(m02) {
            m02 = trim(m02[0].nodeValue);
            if(m02=="Forbidden") {
              callbackFn("Not available");
              return;
            } else {
              // Not sure what to make of this
              callbackFn("Not available"); //Ma 3am nle2e hal siyyara lyom. Please rja3 jarreb ba3d shway. Sorry :/";
              return;
            }
          } else {
            // Not sure what to make of this
            callbackFn("Not available"); //Did you enter your car specifications correctly?";
            return;
          }
        }
    
    }); // end request.post
  
  }); // end request.get

};
