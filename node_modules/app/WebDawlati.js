var http=require('http'); 
var request=require('request'); // https://github.com/request/request
var should = require('should');
var xpath=require('xpath'); // https://www.npmjs.com/package/xpath
var dom = require('xmldom').DOMParser;
var Validator = require('app/Validator');


exports.handler = function(data,callbackFn) {

if(!Validator.validArea(data.a)) {
callbackFn("Invalid area code");
return;
}

    var options = {
        url:'http://www.dawlati.gov.lb/en/mecanique',
        timeout:5000,
        headers: {
          'Cache-Control': 'no-cache'
         }
    };

    request.get(options, function(err,res,body) {

if(res.statusCode!=200) { callbackFn("Not available"); return; }
//      console.log("Got response: " + res.statusCode);
//console.log("data",data);

body=body.replace(/(<form[^>]*>[^<]*<\/form>)/,"$1"); // simplifying html

var doc = new dom().parseFromString(body)
var fat1 = xpath.select("//form[@id='_dawlatimecanique_WAR_dawlatimecaniqueportlet_fm']/@action", doc)[0].nodeValue;
var fat2 = xpath.select("//form[@id='_dawlatimecanique_WAR_dawlatimecaniqueportlet_fm']//input[@name='__ncforminfo']/@value", doc)[0].nodeValue;

	// check valid inputs
	//$fat32=array("Private cars","Motorcycles","Mass public transport trucks","Taxis","Public buses & minibuses","Private transport vehicles","Other private vehicles: Ambulances, etc...");
	Validator.validDawlatiMechanique(xpath.select('//td[@id="zVehiculeType"]//input[@name="_dawlatimecanique_WAR_dawlatimecaniqueportlet_vehicleType"]/@value'),data.t,"car type");
	Validator.validDawlatiMechanique(xpath.select('//select[@id="_dawlatimecanique_WAR_dawlatimecaniqueportlet_modelYear"]//option/@value'),data.y,"model year");
	Validator.validDawlatiMechanique(xpath.select('//td[@id="zHorsePower"]//input[@name="_dawlatimecanique_WAR_dawlatimecaniqueportlet_horsePower"]/@value'),data.hp,"horse power");


        options.form={
		'_dawlatimecanique_WAR_dawlatimecaniqueportlet_modelYear': data.y,
		'_dawlatimecanique_WAR_dawlatimecaniqueportlet_horsePower': data.hp,
		'_dawlatimecanique_WAR_dawlatimecaniqueportlet_vehicleType': data.t,
		'_dawlatimecanique_WAR_dawlatimecaniqueportlet_plateNumber' : data.n,
		'_dawlatimecanique_WAR_dawlatimecaniqueportlet_areaCode': data.a
        };
        request.post(
            options,
            function (error, response, body) {
                if (error || response.statusCode != 200) {
                  callbackFn("Not available");
                  return;
                }

body=body.replace(/(<table[^>]*zResult[^>]*>[^<]*<\/table>)/,"$1"); // simplifying html


//                    console.log(body)
// http://stackoverflow.com/questions/16010551/getting-element-using-xpath-and-cheerio
var doc = new dom().parseFromString(body)
var m0 = xpath.select("//table[@id='zResult']/tr[1]/td[1]", doc);
//console.log("M1",m2,data);

	if(m0.length>0) { // \TODO continue here
                m2 = xpath.select("//tr[@style='background-color:#E1E6EB;']/td[2]/text()", doc).toString()
	}
	m2 = m2.replace(/[\n\t\r]/g,"");
//console.log("M2",m2,data);

	// some string manipulation
	if(m2=="No violation") m2="None";

                    callbackFn(m2);
            }
        );

    }); // end request.get

};
